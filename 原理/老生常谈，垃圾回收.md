## å‰è¨€

è¯»å®Œè¿™ç¯‡æ–‡ç« ä½ èƒ½äº†è§£ä»€ä¹ˆ:question:

åœ¨JavaScriptä¸­å†…å­˜ç®¡ç†æ˜¯è‡ªåŠ¨çš„ï¼Œåœ¨å¼€å‘ä¸­æˆ‘ä»¬ä¸éœ€è¦è‡ªå·±æ‰‹åŠ¨åˆ†é…å†…å­˜ï¼Œé‡Šæ”¾å†…å­˜ã€‚é‚£å¹²å˜›çœ‹è¿™ç¯‡æ–‡ç« ï¼Ÿ

å½“ç„¶æ˜¯å­¦æ€æƒ³å’Œæ–¹æ³•å•¦ï¼Œéš¾é“æ˜¯ä¸ºäº†è£…é€¼13å—ã€‚æŠ€æœ¯éƒ½æ˜¯äº’é€šçš„ï¼Œæ‡‚çš„åŽŸç†å¯¹æ€§èƒ½ä¼˜åŒ–ä¹Ÿæ˜¯æœ‰å¥½å¤„æ»´ã€‚

- V8å¼•æ“Žçš„åžƒåœ¾æœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œçš„
- æ–°ä¸€ä»£åžƒåœ¾æ”¶é›†å™¨**Orinoco**å¦‚ä½•å‡å°‘åžƒåœ¾å›žæ”¶çš„é˜»å¡žæ—¶é—´
- å­¦åˆ°ä¸€äº›æ€§èƒ½ä¼˜åŒ–çš„æ€æƒ³

> æ–‡ç« å†…å®¹å¤§å¤šç¿»è¯‘è‡³ï¼šhttps://v8.dev/blog/trash-talkï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥åŽ»åº·åº·å¤§ä½¬å†™çš„åŽŸæ–‡ã€‚

## ä¸ºä»€ä¹ˆè¦è¿›è¡Œåžƒåœ¾å›žæ”¶

å› ä¸ºç”µè„‘çš„å†…å­˜ä¸æ˜¯æ— é™çš„ï¼Œå¦‚æžœä¸è¿›è¡Œåžƒåœ¾å›žæ”¶ï¼Œå†…å­˜å°±ä¼šç‚¸æŽ‰ï¼Œè¿™å°±åƒåƒåœ°çƒðŸŒçš„èµ„æºä¸€æ ·ï¼ˆå¯æŒç»­å‘å±•ç›´å‘¼å†…è¡Œï¼‰ã€‚

åžƒåœ¾å›žæ”¶çš„ä½œç”¨å°±æ˜¯åªç•™ä¸‹è¿è¡Œæ—¶å¿…è¦çš„å†…å­˜ï¼Œå…¶å®ƒä¸ç”¨çš„åžƒåœ¾ç»Ÿç»Ÿæ¸…ç†æŽ‰ï¼Œç•™åˆ°åŽç»­è¦åˆ†é…å†…å­˜çš„æ—¶å€™ä½¿ç”¨ã€‚

![åžƒåœ¾è½¦](http://ww2.sinaimg.cn/bmiddle/9150e4e5ly1fmaw41nf2mj20u20pvwgd.jpg)

## åžƒåœ¾å›žæ”¶ç—›ç‚¹

ä¼—æ‰€å‘¨çŸ¥ï¼ŒJavaScriptæ˜¯å•çº¿ç¨‹çš„ã€‚ä¸ºä¿è¯æ•°æ®åŒæ­¥ï¼Œåœ¨è¿›è¡Œåžƒåœ¾å›žæ”¶æ—¶ï¼Œæœ€ç®€å•çš„åŠžæ³•å°±æ˜¯æš‚åœJavaScriptçš„æ‰§è¡Œï¼Œç„¶åŽGCå¼€å§‹å·¥ä½œï¼Œå®Œæˆä¹‹åŽå†ç»§ç»­æ‰§è¡ŒJavaScriptã€‚

> åžƒåœ¾å›žæ”¶å™¨ï¼ˆgrabage collectorï¼‰ï¼Œç®€ç§°GC

è¿™ä¹ˆåšåŠ¿å¿…ä¼šé€ æˆé¡µé¢çš„å¡é¡¿ï¼Œå¦‚ï¼šç”¨æˆ·æ“ä½œä¸å“åº”ï¼Œé¡µé¢åŠ¨ç”»ä¸è¿žç»­ã€‚

åœ¨V8çš„è€ä¸€ä»£çš„åžƒåœ¾å›žæ”¶æœºåˆ¶ä¸­ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§åšæ³•ã€‚è€Œåœ¨è°·æ­ŒV8å›¢é˜Ÿç ”å‘çš„æ–°ä¸€ä»£åžƒåœ¾å›žæ”¶å™¨ï¼ˆä»£å·ï¼š**Orinoco**ï¼‰ä¸­ï¼Œå°±æ˜¯é’ˆå¯¹è¿›è¡Œåžƒåœ¾å›žæ”¶æ—¶ä¼šé€ æˆé¡µé¢å¡é¡¿è¿™ä¸ªç—›ç‚¹è¿›è¡Œä¼˜åŒ–ã€‚Orinocoåšäº†å¾ˆå¤šä¼˜åŒ–æ‰‹æ®µï¼Œä¸ºçš„å°±æ˜¯å°½å¯èƒ½çš„**å‡å°‘åžƒåœ¾å›žæ”¶å¯¹ä¸»çº¿ç¨‹çš„é˜»å¡ž**ï¼Œä½¿ç”¨æˆ·æ„Ÿè§‰ä¸åˆ°é¡µé¢çš„å¡é¡¿ã€‚

## åžƒåœ¾å›žæ”¶åŸºæœ¬åŽŸç†

ä»»ä½•åžƒåœ¾å›žæ”¶æœºåˆ¶éƒ½ä¼šå‘¨æœŸæ€§çš„æ‰§è¡Œä¸€äº›åŸºæœ¬æ­¥éª¤ï¼š

1. æ‰¾åˆ°å“ªäº›æ˜¯åžƒåœ¾ï¼ˆå‡‰å‡‰çš„å¯¹è±¡ï¼Œdead objectsï¼‰ï¼Œå“ªäº›ä¸æ˜¯åžƒåœ¾ï¼ˆæ´»åŠ¨å¯¹è±¡ï¼Œlive objectsï¼‰
2. å›žæ”¶å†åˆ©ç”¨é‚£äº›åžƒåœ¾å ç”¨çš„å†…å­˜
3. åŽ‹ç¼©/æ•´ç†åžƒåœ¾ç•™ä¸‹çš„ç¢Žç‰‡ï¼ˆå¯é€‰ï¼‰

è¿™äº›ä»»åŠ¡å¯ä»¥æŒ‰é¡ºåºè¿›è¡Œï¼Œä¹Ÿå¯ä»¥ä»»æ„äº¤é”™è¿›è¡Œã€‚

## V8ä¸­çš„GCæ˜¯å¦‚ä½•å·¥ä½œçš„

å®žé™…ä¸Šï¼Œåœ¨V8ä¸­ï¼Œæœ‰ä¸¤ä¸ªåžƒåœ¾å›žæ”¶å™¨ï¼Œåˆ†åˆ«æ˜¯

- Major GCï¼ˆä¸»GCï¼‰ï¼ŒåˆåFull Mark-Compact
- Minor GCï¼ˆæ¬¡GCï¼‰ï¼ŒåˆåScavenger

æ¯ä¸ªGCå·¥ä½œåœ¨ä¸åŒçš„é˜¶æ®µã€‚

### ä¸»GCå·¥ä½œæµç¨‹

ä¸»GCæ˜¯é€šè¿‡éåŽ†æ•´ä¸ªå †å†…å­˜æ¥è¿›è¡Œåžƒåœ¾å›žæ”¶ã€‚ä¸»GCåœ¨**æ ‡è®°**ï¼ˆmarkingï¼‰ã€**æ¸…é™¤**ï¼ˆsweepingï¼‰å’Œ**åŽ‹ç¼©**ï¼ˆcompactingï¼‰ä¸‰ä¸ªé˜¶æ®µè¿›è¡Œå·¥ä½œã€‚

#### æ ‡è®°ðŸ“Œ

æ ‡è®°æ˜¯çš„åŒºåˆ†åžƒåœ¾å¯¹è±¡å’Œæ´»åŠ¨å¯¹è±¡çš„å…¶ä¸­ä¸€ç§æ–¹å¼ã€‚å…ˆæ¥è¯´è¯´å¦ä¸€ç§æ–¹å¼ï¼š**å¼•ç”¨è®¡æ•°**ã€‚

##### å¼•ç”¨è®¡æ•°

åœ¨è€ä¸€ä»£çš„æµè§ˆå™¨ä¸­ï¼Œæ˜¯ä½¿ç”¨å¼•ç”¨è®¡æ•°æ¥åŒºåˆ†å½“å‰å¯¹è±¡æ˜¯ä¸æ˜¯åžƒåœ¾ã€‚

å½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯ä¸ªåžƒåœ¾ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸ä¸º0æ—¶ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯æ´»åŠ¨å¯¹è±¡ã€‚

ä¸¾ä¸ªä¾‹å­ðŸŒ°

```javascript
let obj = { a: 1 }; // objå…·æœ‰è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°ä¸º1ï¼Œä¸æ˜¯åžƒåœ¾
```

```js
obj = null; // å¼•ç”¨æ²¡äº†ï¼Œå¼•ç”¨è®¡æ•°ä¸º0ï¼Œæ­å–œ{ a:1 }ðŸ‘æˆä¸ºåžƒåœ¾
```

ä½†æ˜¯è¿™ä¸ªæ–¹æ³•æœ‰ä¸ªè‡´å‘½çš„é—®é¢˜ï¼Œå¾ªçŽ¯å¼•ç”¨

![æ— é™å¾ªçŽ¯](https://i.loli.net/2021/04/30/I9oqV3pFB1D7dMT.gif)

ä¸¾ä¸ªä¾‹å­ðŸŒ°

```js
let obj1 = {}; // obj1å…·æœ‰è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™é‡Œç§°ä¸ºå¯¹è±¡aï¼Œå¯¹è±¡açš„å¼•ç”¨è®¡æ•°ä¸º1
let obj2 = {}; // obj1å…·æœ‰è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ï¼Œè¿™é‡Œç§°ä¸ºå¯¹è±¡bï¼Œå¯¹è±¡bå¼•ç”¨è®¡æ•°ä¸º1
obj1.foo = obj2; // obj1.fooå…·æœ‰å¯¹è±¡bçš„å¼•ç”¨ï¼Œå¯¹è±¡bå¼•ç”¨è®¡æ•°ä¸º2
obj2.foo = obj1; // obj2.fooå…·æœ‰å¯¹è±¡açš„å¼•ç”¨ï¼Œå¯¹è±¡aå¼•ç”¨è®¡æ•°ä¸º2
```

çŽ°åœ¨æŠŠobj1å’Œobj2éƒ½å¹²æŽ‰

```js
obj1 = null;
obj2 = null;
```

**ç„¶åŽçŽ°åœ¨å¯¹è±¡aå’Œå¯¹è±¡bè¿˜æ˜¯äº’ç›¸å¼•ç”¨çš„ï¼Œå¼•ç”¨è®¡æ•°æ°¸è¿œä¸º1ï¼Œè¿™ä¸ªåžƒåœ¾å°±æ°¸è¿œæ¸…ç†ä¸æŽ‰**

![å¾ªçŽ¯å¼•ç”¨](https://raw.githubusercontent.com/wcly/figure-bed/main/image-20210429164938479.png?token=AFRSMHGE3IVYHMFS74NSICTARNP2W)

##### æ ‡è®°

ç”±äºŽå¼•ç”¨è®¡æ•°æœ‰bugï¼Œæ‰€ä»¥çŽ°åœ¨çš„æµè§ˆå™¨GCä½¿ç”¨çš„å¤§éƒ¨åˆ†ç”¨çš„æ˜¯**æ ‡è®°æ¸…é™¤æ³•**ï¼ˆmark-and-sweepï¼‰ã€‚

å…¶ä¸­**æ ‡è®°**æ˜¯GCå·¥ä½œçš„ä¸€ä¸ªé‡è¦æ­¥éª¤ã€‚GCä¼šä»Žå‡ ç»„**æ ¹æŒ‡é’ˆ**å¼€å§‹å¾€ä¸‹æ‰¾ï¼Œç›´åˆ°æŠŠè¿è¡Œæ—¶çš„å¯¹è±¡å…¨éƒ¨æ‰“ä¸Šæ ‡è®°ä¸ºæ­¢ã€‚æ‰¾åˆ°çš„å¯¹è±¡ï¼ˆreachable objectsï¼‰å°±æ ‡è®°ä¸ºæ´»åŠ¨å¯¹è±¡ï¼Œæ²¡æ‰¾åˆ°çš„å¯¹è±¡å°±æ ‡è®°ä¸ºåžƒåœ¾ã€‚

>  æ ¹æŒ‡é’ˆæ˜¯å•¥ï¼Ÿ

- å½“å‰å‡½æ•°çš„å±€éƒ¨å˜é‡å’Œå‚æ•°ã€‚
- åµŒå¥—è°ƒç”¨æ—¶ï¼Œå½“å‰è°ƒç”¨é“¾ä¸Šæ‰€æœ‰å‡½æ•°çš„å˜é‡ä¸Žå‚æ•°ã€‚
- å…¨å±€å˜é‡ã€‚
- ï¼ˆè¿˜æœ‰ä¸€äº›å†…éƒ¨çš„ï¼‰

#### æ¸…é™¤

**æ¸…é™¤**å°±æ˜¯æŠŠæ ‡è®°ä¸ºåžƒåœ¾çš„å¯¹è±¡å…¨éƒ¨å¹²æŽ‰ã€‚

å…ˆæ¥ä¸€å¼ æ ‡è®°åŠ æ¸…é™¤ä¸€èµ·å·¥ä½œçš„å›¾ï¼š

![mark and sweep](https://user-gold-cdn.xitu.io/2019/12/8/16ee468e85a1084d?imageslim)

å†çœ‹çœ‹ä¸»GCå…·ä½“çš„æ€Žä¹ˆåšçš„:

ä¸»GCä¼šå°†åžƒåœ¾å ç”¨çš„å†…å­˜æ·»åŠ åˆ°ä¸€ä¸ªå«**ç©ºé—²åˆ—è¡¨ï¼ˆfree-listï¼‰**çš„æ•°æ®ç»“æž„ä¸­ã€‚åœ¨å®Œæˆæ ‡è®°æ“ä½œä¹‹åŽï¼ŒGCå°±ä¼šæ‰¾åˆ°ç›¸è¿žçš„â€åžƒåœ¾â€œä»¬ï¼Œå°†ä»–ä»¬æ·»åŠ åˆ°åˆé€‚çš„ç©ºé—²åˆ—è¡¨ä¸­ã€‚ç©ºé—²åˆ—è¡¨çš„å†…å­˜å—é€šè¿‡å†…å­˜å—å¤§å°åˆ†å‰²ï¼Œæ–¹ä¾¿æŸ¥æ‰¾ã€‚å½“éœ€è¦é‡æ–°åˆ†é…å†…å­˜çš„æ—¶ï¼Œåªéœ€åŽ»ç©ºé—²åˆ—è¡¨ä¸­æ‰¾ä¸€ä¸ªå¤§å°åˆé€‚çš„å†…å­˜å—ã€‚

![image-20210430090703579](https://i.loli.net/2021/04/30/wgDfCrzKkyBOLcs.png)

#### åŽ‹ç¼©

ä¸»GCä¼šä½¿ç”¨å¯å‘å¼ç®—æ³•å¯¹éƒ¨åˆ†é¡µé¢é¡µé¢è¿›è¡ŒåŽ‹ç¼©ï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰ç‚¹åƒwindowçš„ç£ç›˜æ¸…ç†åŠŸèƒ½ã€‚

![image-20210430094525931](https://i.loli.net/2021/04/30/svw3CbIAYpHTPrd.png)

GCä¼šå°†ä¸€ä¸ªé¡µé¢ä¸­çš„æ´»åŠ¨å¯¹è±¡çš„å¤åˆ¶åˆ°å¦ä¸€ä¸ªæœªè¿›è¡ŒåŽ‹ç¼©å¤„ç†çš„é¡µé¢ï¼Œä»Žè€Œæœ€å¤§åŒ–åˆ©ç”¨å†…å­˜ç©ºé—´ã€‚

åœ¨å¤åˆ¶æ´»åŠ¨å¯¹è±¡çš„æ—¶å€™ï¼Œæœ‰ä¸ªéšæ‚£ï¼Œå¦‚æžœè¿™ä¸ªå¯¹è±¡çš„å¯¿å‘½å¾ˆé•¿ï¼Œé‚£ä¼šå¤åˆ¶è¿™äº›å¯¹è±¡ä¼šä»˜å‡ºå¾ˆé«˜æ˜‚çš„ä»£ä»·ï¼ˆä½¿ç”¨ä¸­çš„å¯¹è±¡çš„å€¼éšæ—¶å¯èƒ½å˜åŒ–ï¼Œè¦æ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹å¤åˆ¶ç§»åŠ¨å¯¹è±¡ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‡ºçŽ°æ‰¾ä¸åˆ°å½“å‰å¯¹è±¡ç­‰ä¸å¯é¢„çŸ¥çš„é—®é¢˜ï¼‰ã€‚æ‰€ä»¥ä¸»GC**åªä¼šé€‰æ‹©é‚£äº›é«˜åº¦ç¢Žç‰‡åŒ–çš„åŽ‹é¢è¿›è¡ŒåŽ‹ç¼©æ“ä½œï¼Œå…¶å®ƒé¡µé¢åªä¼šé€‰æ‹©è¿›è¡Œæ¸…ç†æ“ä½œ**ã€‚

![image-20210430094704457](https://i.loli.net/2021/04/30/7DmhBzKse25aVYN.png)



### æ¬¡GCå·¥ä½œæµç¨‹

#### ä¸–ä»£å¸ƒå±€

åœ¨è¯´æ¬¡GCå·¥ä½œæµç¨‹çš„æ—¶å€™ï¼Œå…ˆè¯´è¯´ä¸–ä»£å¸ƒå±€çš„æ¦‚å¿µã€‚

åœ¨V8ä¸­ä½¿ç”¨çš„å †ä¼šè¢«åˆ†æˆå‡ ä¸ªåŒºåŸŸï¼Œè¿™äº›ä¸ªåŒºåŸŸè¢«ç§°ä¸º**ä¸–ä»£**ï¼ˆgenerationsï¼‰ï¼Œä¸–ä»£åˆ†ä¸º**å¹´è½»ä¸€ä»£**(young generation)å’Œ**è€ä¸€ä»£**ï¼ˆold generationï¼‰ï¼Œå¹´è½»ä¸€ä»£åˆè¿›ä¸€æ­¥åˆ†ä¸º**å¹¼å„¿å›­**ï¼ˆnurseryï¼‰å’Œ**ä¸­å­¦ç”Ÿ**(intermediate)ã€‚

- ä¸€å¼€å§‹å¯¹è±¡ä¼šåœ¨åˆ†é…åˆ°å¹¼å„¿å›­åŒºåŸŸï¼›
- å¦‚æžœåœ¨å¹¼å„¿å›­ç»åŽ†äº†ä¸€è½®GCæ“ä½œåŽæ²¡è¢«å¹²æŽ‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±ä¼šç§»åŠ¨åˆ°ä¸­å­¦ç”ŸåŒºåŸŸï¼›
- å¦‚æžœå†ç»åŽ†ä¸€è½®GCè¿˜æ²¡è¢«å¹²æŽ‰ï¼Œå°±ä¼šç§»åŠ¨åˆ°è€ä¸€ä»£ä¸­ã€‚

è¿™ä¹ˆè¯´æœ‰ç‚¹æŠ½è±¡ï¼Œæ¥ä¸€å¼ å›¾ï¼š

![image-20210430095757127](https://i.loli.net/2021/04/30/Lox1G2w36y8QJaK.png)

#### ä¸–ä»£å‡è¯´

åœ¨åžƒåœ¾å›žæ”¶æœºåˆ¶ä¸­æœ‰ä¸ªé‡è¦çš„æ¦‚å¿µå«ä¸–ä»£å‡è¯´ï¼Œè¿™ä¸ªå‡è¯´è¯´çš„å°±æ˜¯**å¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ´»ä¸ä¹…**ã€‚åœ¨GCçœ‹æ¥ï¼Œå¾ˆå¤šå¯¹è±¡åŸºæœ¬ä¸Šåœ¨åˆšå£°æ˜Žä¸ä¹…å°±æ— æ³•è®¿é—®äº†ã€‚æ¯”å¦‚ï¼Œä½ åœ¨å‡½æ•°ä¸­å£°æ˜Žçš„å¯¹è±¡ï¼Œè¿™ä¸ªå‡½æ•°ä¸€æ‰§è¡Œå®Œï¼Œé‡Œé¢çš„å£°æ˜Žçš„å¯¹è±¡é©¬ä¸Šå°±è®¿é—®ä¸åˆ°äº†ã€‚è¿™ä¸ªæ¦‚å¿µä¸æ˜¯V8æˆ–è€…JavaScriptç‹¬æœ‰çš„ï¼Œä»»ä½•åŠ¨æ€è¯­è¨€éƒ½é€‚ç”¨ã€‚

**V8çš„ä¸–ä»£å¸ƒå±€å°±å……åˆ†çš„åˆ©ç”¨ä¸–ä»£å‡è¯´è¿™ä¸ªäº‹å®ž**ã€‚è™½ç„¶åœ¨GCå·¥ä½œçš„æ—¶å€™å¤åˆ¶å¯¹è±¡æˆæœ¬å¾ˆé«˜ï¼Œä½†æ˜¯æ ¹æ®ä¸–ä»£å‡è¯´ï¼Œæˆ‘ä»¬çŸ¥é“å®žé™…ä¸Šèƒ½æ´»ä¸‹æ¥çš„åªæ˜¯ä¸€å°éƒ¨åˆ†çš„å¯¹è±¡ã€‚å­˜æ´»ä¸ä¹…çš„æ”¾åœ¨å¹´è½»ä¸€ä»£ä¸­ï¼Œå­˜æ´»å¾—ä¹…çš„è½¬ç§»åˆ°è€ä¸€ä»£ä¸­ï¼Œç„¶åŽä½¿ç”¨ä¸åŒçš„GCè¿›è¡Œæ“ä½œï¼ŒåŒºåˆ«å¯¹å¾…ã€‚å…¶å®žV8æ”¯ä»˜çš„æˆæœ¬åªæ˜¯å’Œè¿™é•¿ä¹…æ´»ä¸‹æ¥çš„ä¸€å°éƒ¨åˆ†å¯¹è±¡æˆæ­£æ¯”çš„ï¼Œè€Œä¸æ˜¯å£°æ˜Žçš„å¤šå°‘å¯¹è±¡å°±èŠ±è´¹å¤šå°‘æˆæœ¬ã€‚

#### å·¥ä½œæµç¨‹

ä¸Šé¢æœ‰è¯´åˆ°ï¼ŒV8æœ‰ä¸¤ä¸ªåžƒåœ¾æ¸…ç†å™¨ï¼Œä¸»GCæ˜¯åœ¨æ•´ä¸ªå †ä¸Šå·¥ä½œçš„ï¼Œè€Œæ¬¡GCæ˜¯åœ¨**å¹´è½»ä¸€ä»£**ä¸Šå·¥ä½œçš„ã€‚

> ä¸»GCå·²ç»å¯ä»¥åœ¨æ•´ä¸ªå †ä¸Šè¿›è¡Œåžƒåœ¾å›žæ”¶äº†ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦æ¬¡GCï¼Ÿ

å› ä¸ºæ ¹æ®**ä¸–ä»£å‡è¯´**ï¼Œæ–°åˆ†é…çš„å¯¹è±¡å¯¿å‘½å¾ˆçŸ­ðŸ‘¶ï¼Œå¾ˆéœ€è¦åžƒåœ¾å›žæ”¶ã€‚

> æ¬¡GCçš„å·¥ä½œæ­¥éª¤æœ‰å“ªäº›ï¼Ÿ

æ¬¡GCä¸»è¦åšä¸‰ä¸ªæ­¥éª¤ï¼š**æ ‡è®°**ï¼ˆmarkingï¼‰ã€**æ’¤ç¦»**ï¼ˆevacuatingï¼‰ã€**æŒ‡é’ˆæ›´æ–°**ï¼ˆpointer-updatingï¼‰ã€‚è¿™ä¸‰ä¸ªæ­¥éª¤æ˜¯åœ¨ä¸åŒé˜¶æ®µäº¤æ›¿è¿›è¡Œçš„ã€‚æ ‡è®°ä¹‹å‰è¯´äº†è¿™é‡Œå°±ä¸é‡å¤äº†ã€‚

##### æ’¤ç¦»

ä¸»GCæ˜¯é€šè¿‡å¯å‘å¼ç®—æ³•å¯¹éƒ¨åˆ†é«˜åº¦ç¢Žç‰‡åŒ–çš„é¡µé¢ï¼ˆåŽ‹ç¼©ï¼‰è¿›è¡Œç¢Žç‰‡æ¸…ç†å·¥ä½œï¼Œè€Œæ¬¡GCåˆ™æ˜¯ä½¿ç”¨**æ’¤ç¦»**çš„æ–¹å¼è¿›è¡Œç¢Žç‰‡æ¸…ç†ã€‚

V8ä¸ºå¹´è½»ä¸€ä»£ä½¿ç”¨ä¸€ä¸ªå«semi-pageçš„è®¾è®¡ï¼Œä¸ºäº†åšæ’¤ç¦»æ“ä½œï¼Œæ€»ç©ºé—´ä¸­æœ‰ä¸€åŠæ˜¯ç©ºçš„ã€‚æ€»ç©ºé—´è¢«åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€å¼€å§‹ç©ºçš„é‚£ä¸ªç©ºé—´å«To-Spaceï¼Œéœ€è¦å¤åˆ¶çš„åœ°æ–¹å«From-Spaceï¼Œå…¶å®žå°±æ˜¯å¯¹åº”å¹¼å„¿å›­å’Œä¸­å­¦ç”Ÿã€‚

**é¦–å…ˆ**ï¼Œæ¬¡GCä¼šå°†æ‰€æœ‰æ´»åŠ¨å¯¹è±¡æ’¤ç¦»åˆ°ä¸€ä¸ªè¿žç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œä»Žè€Œå®Œæˆç¢Žç‰‡æ¸…ç†å·¥ä½œã€‚

![image-20210430104635380](https://i.loli.net/2021/04/30/jRHAhgwpiWct1Ud.png)

**æŽ¥ç€**ï¼ŒGCä¼šè°ƒæ¢From-Spaceå’ŒTo-Spaceï¼Œæ–°åˆ†é…çš„å¯¹è±¡ä¼šå…ˆæ·»åŠ åˆ°From-Spaceæœ€ä¸‹é¢ï¼Œç„¶åŽé©¬ä¸Šæ’¤ç¦»åˆ°To-Spaceã€‚

![image-20210430104757470](https://i.loli.net/2021/04/30/r9pzCNLmtWfTG4V.png)

##### æ›´æ–°æŒ‡é’ˆ

è¿™æ ·æ¢ä¸‹åŽ»ï¼Œå¾ˆå¿«ç©ºé—´å°±ä¼šç”¨å®Œï¼Œæ‰€æœ‰åœ¨ç¬¬äºŒè½®GCçš„æ—¶å€™ä¼šæŠŠå‰©ä¸‹çš„æ´»åŠ¨å¯¹è±¡è¿ç§»åˆ°è€ä¸€ä»£ä¸­ï¼Œæœ€åŽæ›´æ–°ä¸€ä¸‹åŽŸæ¥æŒ‡é’ˆçš„æŒ‡å‘ã€‚

![image-20210430105148846](https://i.loli.net/2021/04/30/wNUvjKO6C4qVy1Y.png)

## Orinoco

å¥½äº†ï¼Œç»ˆäºŽè¯´åˆ°æˆ‘ä»¬çš„é‡ç‚¹äº†ï¼ŒåŽŸæ¥çš„åžƒåœ¾å¤„ç†æœºåˆ¶æ˜¯ä¼šé˜»æ­¢ä¸»çº¿ç¨‹çš„è¿è¡Œç›´åˆ°åžƒåœ¾å›žæ”¶çš„æ•´ä¸ªè¿‡ç¨‹å®Œæˆï¼Œ**è¡¡é‡åžƒåœ¾å›žæ”¶æ€§èƒ½çš„ä¸€é¡¹é‡è¦æŒ‡æ ‡æ˜¯GCæ‰§è¡Œæ—¶ä¸»çº¿ç¨‹çš„æš‚åœæ—¶é—´**ã€‚æˆ‘ä»¬çŽ°åœ¨æ¥çœ‹çœ‹Orinocoåšäº†å“ªäº›ä¼˜åŒ–ã€‚

Orinocoä¸»è¦ä½¿ç”¨**å¹¶è¡Œ**ï¼ˆparallelï¼‰ã€**å¢žé‡**ï¼ˆincrementalï¼‰å’Œ**å¹¶è¡Œ**ï¼ˆconcurrentï¼‰è¿™ä¸‰ç§æŠ€æœ¯æ¥é‡Šæ”¾ä¸»çº¿ç¨‹ã€‚

![](http://wx4.sinaimg.cn/bmiddle/006I1bcHgy1frm1h2obq4j307x08fglp.jpg)

### å¹¶è¡Œ

**å¹¶è¡Œ**å°±æ˜¯æŒ‡ä¸»çº¿ç¨‹å’Œè¾…åŠ©çº¿ç¨‹åœ¨åŒä¸€ä¸ªæ—¶é—´åšå¤§è‡´ç­‰é‡çš„å·¥ä½œã€‚è¿™è™½ç„¶è¿˜æ˜¯ä¼šé˜»å¡žä¸»çº¿ç¨‹ï¼Œä½†æ˜¯é˜»å¡žçš„æ—¶é—´ä¼šå‡å°‘ï¼Œæ€»é˜»å¡žæ—¶é—´ä¼šå˜æˆåŽŸæ¥çš„nï¼ˆçº¿ç¨‹çš„æ€»æ•°ï¼‰åˆ†ä¹‹ä¸€ã€‚

è¿™æ˜¯ä¸‰ç§æŠ€æœ¯ä¸­æœ€ç®€å•çš„ä¸€ç§ã€‚ç”±äºŽè¿™æ—¶å€™jsæ˜¯åœæ­¢æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åªéœ€è¦è§£å†³å„ä¸ªè¾…åŠ©çº¿ç¨‹åœ¨è®¿é—®åŒä¸€ä¸ªå¯¹è±¡æ—¶çš„æ•°æ®åŒæ­¥é—®é¢˜å³å¯ã€‚

![å¹¶è¡Œ](https://i.loli.net/2021/04/30/hjEkprYeMWmiytx.png)

### å¢žé‡

**å¢žé‡**æ˜¯æŒ‡ä¸»çº¿ç¨‹é—´æ­‡æ€§çš„æ‰§è¡Œä¸€å°éƒ¨åˆ†å·¥ä½œã€‚æŠŠæ•´ä¸ªGCæ“ä½œåˆ‡æˆä¸€å°å—ä¸€å°å—çš„ï¼Œæ¯æ¬¡æ‰§è¡ŒGCçš„ä¸€å°éƒ¨åˆ†å·¥ä½œã€‚è¿™ç§æ–¹å¼è¦éš¾å¾ˆå¤šï¼Œå› ä¸ºJavaScriptæ‰§è¡Œæ˜¯å¤¹æ‚åœ¨å¢žé‡ä¸­çš„ï¼Œæ‰€ä»¥å¾ˆæœ‰å¯èƒ½åœ¨å› ä¸ºå †çŠ¶æ€çš„å˜åŒ–ï¼Œå¯¼è‡´ä¹‹å‰çš„ä¸€ä¸ªå¢žé‡å·¥ä½œæ— æ•ˆã€‚

ä»Žä¸‹å›¾å¯ä»¥çœ‹å‡ºï¼Œè¿™å¹¶ä¸ä¼šå‡å°‘GCä»»åŠ¡çš„æ€»æ‰§è¡Œæ—¶é—´ï¼Œç”šè‡³ç¨å¾®ä¼šå¢žåŠ ä¸€ç‚¹ã€‚ä½†æ˜¯è¿™æ˜¯ä¸€ä¸ªå‡å°‘**JavaScripté˜»å¡žæ—¶é—´**çš„å¥½æ–¹æ³•ã€‚é€šè¿‡å…è®¸JavaScripté—´æ­‡æ€§çš„è¿è¡Œå¯ä»¥ä¿è¯ç¨‹åºåœ¨GCæ“ä½œä¸­ä¾ç„¶å¯ä»¥å“åº”ç”¨æˆ·çš„è¾“å…¥å’ŒåŠ¨ç”»çš„æ‰§è¡Œã€‚

![å¢žé‡](https://i.loli.net/2021/04/30/Pb7haiVrzyNcv5B.png)

### å¹¶å‘

**å¹¶å‘**æŒ‡çš„æ˜¯å®Œå…¨ä¸é˜»å¡žJavaScriptæ‰§è¡Œï¼ŒGCçš„æ­¥éª¤å…¨éƒ¨é€šè¿‡è¾…åŠ©çº¿ç¨‹åœ¨åŽå°æ‰§è¡Œã€‚

è¿™æ˜¯ä¸‰ç§æŠ€æœ¯ä¸­æœ€éš¾çš„ä¸€ä¸ªï¼Œåœ¨ä»»ä½•æ—¶é—´JavaScriptå †çš„ä»»ä½•ä¸œè¥¿éƒ½æœ‰å¯èƒ½æ”¹å˜ï¼Œå¯¼è‡´ä¹‹å‰åšçš„æ¸…ç†å·¥ä½œæ— æ•ˆã€‚ä¸»çº¿ç¨‹å’Œè¾…åŠ©çº¿ç¨‹è¿˜æœ‰å¯èƒ½åŒæ—¶è¯»å–å’Œä¿®æ”¹ç›¸åŒçš„å¯¹è±¡ï¼Œä¼šå­˜åœ¨read/write racesçš„é—®é¢˜

å¹¶å‘çš„å¥½å¤„æ˜¯é™¤åŽ»ä¸€ç‚¹ç‚¹å’Œè¾…åŠ©çº¿ç¨‹åŒæ­¥çš„å¼€é”€ï¼Œå¯ä»¥å®Œå…¨é‡Šæ”¾ä¸»çº¿ç¨‹åŽ»æ‰§è¡ŒJavaScriptã€‚

![å¹¶å‘](https://i.loli.net/2021/04/30/rS9DIZUoYAEgw32.png)

## Orinocoæ˜¯å¦‚ä½•å°†ä¸‰ç§ä¼˜åŒ–çš„æŠ€æœ¯è¿ç”¨åˆ°GCçš„å„ä¸ªé˜¶æ®µçš„:question:

#### åœ¨æ¬¡GCå·¥ä½œçš„æ—¶å€™ï¼ˆScavengingï¼‰

åœ¨å¹´è½»ä¸€ä»£GCå·¥ä½œçš„æ—¶å€™ï¼ŒV8ä¼šä½¿ç”¨**å¹¶è¡Œ**çš„æ–¹å¼å°†æ¸…ç†å·¥ä½œåˆ†å¸ƒåˆ°å¤šä¸ªè¾…åŠ©çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¹‹ä¸­ã€‚

æ¯ä¸ªçº¿ç¨‹ä¼šåˆ†åˆ«æ”¶åˆ°å‡ ä¸ªæŒ‡é’ˆï¼Œç„¶åŽå°†è¿™äº›æŒ‡é’ˆæŒ‡å‘çš„æ´»åŠ¨å¯¹è±¡æ’¤ç¦»åˆ°To-Spaceã€‚åœ¨æ’¤ç¦»æ—¶ï¼Œè¿™äº›æ¸…ç†ä»»åŠ¡å¿…é¡»ä½¿ç”¨åŽŸå­çš„è¯»å…¥ã€å†™å…¥ã€æ¯”è¾ƒå’Œäº¤æ¢æ“ä½œæ¥ä¿è¯æ•°æ®åŒæ­¥ã€‚

åœ¨ä¸€ä¸ªè¾…åŠ©çº¿ç¨‹å·¥ä½œçš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½é€šè¿‡å…¶å®ƒè·¯å¾„å…ˆæ‰¾åˆ°äº†ç›¸åŒçš„å¯¹è±¡ï¼Œå¹¶è¯•å›¾ç§»åŠ¨è¿™ä¸ªå¯¹è±¡ã€‚ä¸ç®¡æ˜¯å“ªä¸ªçº¿ç¨‹å…ˆæ‰¾åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œéƒ½ä¼šæ›´æ–°è¿™ä¸ªå¯¹è±¡çš„æŒ‡é’ˆåœ°å€å¹¶è¿”å›žã€‚å®ƒä¼šç•™ä¸‹ä¸€ä¸ªè½¬å‘æŒ‡é’ˆç»™å…¶å®ƒçº¿ç¨‹å‘ŠçŸ¥è¿™ä¸ªå¯¹è±¡æ›´æ–°å®Œä¹‹åŽçš„åœ°å€æ˜¯ä»€ä¹ˆã€‚

![image-20210430114057855](https://i.loli.net/2021/04/30/FA1CSRqflb5rLKk.png)

#### åœ¨ä¸»GCå·¥ä½œçš„æ—¶å€™ï¼ˆMajor GCï¼‰

ä¸»GCä½¿ç”¨**å¹¶å‘**æŠ€æœ¯è¿›è¡Œæ ‡è®°å’Œæ¸…ç†æ“ä½œï¼Œä½¿ç”¨**å¹¶è¡Œ**æŠ€æœ¯è¿›è¡ŒåŽ‹ç¼©å’ŒæŒ‡é’ˆæ›´æ–°æ“ä½œã€‚

åœ¨V8ä¸­ä¸»GCæ˜¯é€šè¿‡å¹¶å‘çš„æ ‡è®°å¼€å§‹çš„ã€‚å½“å †æŽ¥è¿‘åŠ¨æ€è®¡ç®—çš„ä¸´ç•Œç‚¹æ—¶ï¼Œå¹¶å‘æ ‡è®°ä»»åŠ¡å°±ä¼šå¼€å§‹ã€‚æ•´ä¸ªå¹¶å‘æ ‡è®°éƒ½å‘ç”Ÿåœ¨åŽå°ï¼Œä¸å½±å“JavaScriptä¸»çº¿ç¨‹çš„è¿è¡Œã€‚

V8ä¼šä½¿ç”¨Write barriersè®°å½•åœ¨å¹¶è¡Œæ ‡è®°æœŸé—´ç”Ÿæˆçš„æ–°å¯¹è±¡çš„å¼•ç”¨ã€‚

å…·ä½“æ­¥éª¤ï¼š

- æ¯ä¸ªè¾…åŠ©çº¿ç¨‹éƒ½ä¼šè¢«åˆ†é…å‡ ä¸ªæŒ‡é’ˆï¼Œç„¶åŽæ ¹æ®è¿™ä¸ªæŒ‡é’ˆåŽ»æ‰¾ï¼Œç»™æ‰¾åˆ°çš„å¯¹è±¡æ‰“ä¸Šæ ‡è®°ã€‚

- å½“å¹¶å‘æ ‡è®°å®Œæˆï¼Œæˆ–è€…åˆ°è¾¾åŠ¨æ€åˆ†é…çš„ä¸´ç•Œå€¼æ—¶ï¼Œä¸»çº¿ç¨‹ä¼šè¿›è¡Œä¸€ä¸ªå¾ˆå¿«çš„æ ‡è®°æ”¶å°¾æ­¥éª¤ã€‚
- ä¸»çº¿ç¨‹å°±è¿™è¿™ä¸ªæ—¶å€™è¢«GCæš‚åœã€‚ç„¶åŽä¸»çº¿ç¨‹å†æ¬¡ä»Žæ ¹èŠ‚ç‚¹å¼€å§‹æ‰«æï¼Œç¡®ä¿æ ‡è®°äº†æ‰€æœ‰çš„æ´»åŠ¨å¯¹è±¡ï¼Œç„¶åŽå’Œå‡ ä¸ªè¾…åŠ©çº¿ç¨‹å¼€å§‹å¹¶è¡Œæ‰§è¡ŒåŽ‹ç¼©å’ŒæŒ‡é’ˆæ›´æ–°æ“ä½œã€‚
- æ¸…ç†å·¥ä½œåœ¨ä¸»çº¿ç¨‹æš‚åœæœŸé—´å¼€å§‹å¹¶è¡Œå·¥ä½œï¼Œä¸å½±å“JavaScriptæ‰§è¡Œã€‚

ä¸æ˜¯æ‰€æœ‰æ—§ç©ºé—´ï¼ˆold-spaceï¼‰é‡Œçš„é¡µé¢éƒ½éœ€è¦è¿›è¡ŒåŽ‹ç¼©æ“ä½œï¼Œé‚£äº›æ²¡æœ‰åŽ‹ç¼©çš„é¡µé¢ä¼šä½¿ç”¨ä¹‹å‰æåˆ°çš„ç©ºé—²åˆ—è¡¨è¿›è¡Œæ¸…ç†ã€‚



![image-20210430114712248](https://i.loli.net/2021/04/30/phVWymDBMICOvX6.png)

#### é—²æš‡æ—¶é—´çš„GCï¼ˆIdle-time GCï¼‰

JavaScriptæ²¡æœ‰ç›´æŽ¥å¯ä»¥æ“ä½œGCçš„æ–¹æ³•ã€‚ä½†æ˜¯V8ç»™å®¿ä¸»çŽ¯å¢ƒæä¾›äº†è§¦å‘GCçš„æ“ä½œã€‚GCä¼šå‘é€ä¸€äº›é—²æš‡ä»»åŠ¡ï¼ˆIdle Tasksï¼‰ï¼Œå°±ç®—å®¿ä¸»ä¸ä¸»åŠ¨è§¦å‘è¿™äº›ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡ä¹Ÿä¼šè¢«GCè‡ªåŠ¨æ‰§è¡Œã€‚

åƒè°·æ­Œæµè§ˆå™¨è¿™ç§å®¿ä¸»ä¼šæœ‰ä¸€äº›ç©ºé—²æ—¶é—´çš„æ¦‚å¿µã€‚è°·æ­Œæµè§ˆå™¨æ¯ç§’ä¼šåˆ·æ–°60æ¬¡ï¼Œæ¯åˆ·æ–°ä¸€æ¬¡ï¼ˆä¸€å¸§ï¼‰å ç”¨çš„æ—¶é—´å¤§æ¦‚æ˜¯16.6msï¼Œåœ¨è¿™16.6mså†…çš„åŠ¨ç”»å¦‚æžœæå‰æ‰§è¡Œå®Œæˆäº†ï¼Œå‰©ä¸‹çš„æ—¶é—´å°±æ˜¯é—²æš‡æ—¶é—´ï¼Œå¯ä»¥ç”¨æ¥æ‰§è¡ŒGCçš„é—²æš‡ä»»åŠ¡ã€‚

GCä¼šåˆ©ç”¨ä¸»çº¿ç¨‹ä¸Šçš„ç©ºé—²æ—¶é—´æ¥ä¸»åŠ¨æ‰§è¡ŒGCå·¥ä½œã€‚åˆ©ç”¨ç©ºé—²æ—¶é—´ï¼Œæ¯æ¬¡æ‰§è¡Œä¸€ç‚¹ç‚¹ðŸ¤ðŸ»ï¼Œå…¶å®žå°±æ˜¯**å¢žé‡**ã€‚

![image-20210430115141940](https://i.loli.net/2021/04/30/QVPr4yUR35wnCzl.png)

## æ€»ç»“

1. V8ä¸­æœ‰ä¸¤ä¸ªGCï¼Œä¸€ä¸ªæ˜¯ä¸»GCï¼Œåœ¨æ•´ä¸ªå †ä¸Šå·¥ä½œï¼Œå¦ä¸€ä¸ªæ˜¯æ¬¡GCï¼Œåœ¨å¹´è½»ä¸€ä»£ä¸Šå·¥ä½œã€‚
2. ç”±äºŽå¤§éƒ¨åˆ†å¯¹è±¡æ´»åŠ¨æ—¶é—´ä¸é•¿ï¼ˆä¸–ä»£å‡è¯´ï¼‰ï¼Œæ‰€ä»¥V8å°†å†…å­˜å †åˆ†æˆäº†å‡ ä¸ªåŒºåŸŸï¼Œä¸åŒçš„GCåœ¨ä¸åŒé¢åŒºåŸŸè¿›è¡Œä¸åŒçš„å¤„ç†ã€‚
3. ä¸»GCä¼šæ‰§è¡Œæ ‡è®°ã€æ¸…é™¤å’ŒåŽ‹ç¼©ä¸‰ä¸ªæ­¥éª¤ã€‚æ¬¡GCä¼šæ‰§è¡Œæ ‡è®°ã€æ’¤ç¦»ã€æŒ‡é’ˆæ›´æ–°ä¸‰ä¸ªæ­¥éª¤ã€‚
4. æ–°ä¸€ä»£GCï¼ˆOrinocoï¼‰ä½¿ç”¨å¹¶è¡Œã€å¢žé‡å’Œå¹¶å‘æŠ€æœ¯å‡å°‘GCå¯¹ä¸»çº¿ç¨‹çš„é˜»å¡žæ—¶é—´ã€‚
5. æ¬¡GCä½¿ç”¨å¹¶è¡ŒæŠ€æœ¯è¿›è¡Œæ’¤ç¦»æ“ä½œã€‚ä¸»GCä½¿ç”¨å¹¶å‘æŠ€æœ¯è¿›è¡Œæ ‡è®°å’Œæ¸…ç†æ“ä½œï¼Œä½¿ç”¨å¹¶è¡ŒæŠ€æœ¯è¿›è¡ŒåŽ‹ç¼©å’ŒæŒ‡é’ˆæ›´æ–°æ“ä½œã€‚



**å‚è€ƒï¼š**

> - https://v8.dev/blog/trash-talk
>
> - https://juejin.cn/post/6844904016325902344
> - https://zh.javascript.info/garbage-collection